#include <Exploit/Environment/Environment.hpp>
#include <Exploit/Environment/Librarys/Http.hpp>
#include <Exploit/Environment/Librarys/Closures.hpp>
#include <Exploit/Environment/Librarys/Miscellaneous.hpp>

static std::string to_lower(std::string s) {
    std::transform(s.begin(), s.end(), s.begin(), [](unsigned char c) { return std::tolower(c); });
    return s;
}

static const std::unordered_set<std::string> dangerous_functions =
{
    "openvideosfolder","openscreenshotsfolder","getrobuxbalance","performpurchase",
    "promptbundlepurchase","promptnativepurchase","promptproductpurchase","promptpurchase",
    "promptthirdpartypurchase","publish","getmessageid","openbrowserwindow",
    "requestinternal","executejavascript","togglerecording","takescreenshot",
    "httprequestasync","getlast","sendcommand","getasync","getasyncfullurl",
    "requestasync","makerequest","postasync","httppost","postasyncfullurl",
    "performpurchasev2","promptgamepasspurchase","promptrobloxpurchase",
    "opennativeoverlay","addcorescriptlocal","emithybridevent","returntojavascript",
    "call","openurl","savescriptprofilingdata","getprotocolmethodrequestmessageid",
    "getprotocolmethodresponsemessageid","publishprotocolmethodrequest",
    "publishprotocolmethodresponse","subscribe","subscribetoprotocolmethodrequest",
    "subscribetoprotocolmethodresponse","promptnativepurchasewithlocalplayer",
    "promptcollectiblespurchase","performbulkpurchase","performcancelsubscription",
    "performsubscriptionpurchase","performsubscriptionpurchasev2",
    "preparecollectiblespurchase","promptbulkpurchase","promptcancelsubscription",
    "promptpremiumpurchase","promptsubscriptionpurchase","openwechatauthwindow",
    "requestlimitedasync","run","capturescreenshot","createpostasync",
    "deletecapture","deletecapturesasync","getcapturefilepathasync",
    "savecapturetoexternalstorage","savecapturestoexternalstorageasync",
    "getcaptureuploaddataasync","retrievecaptures","savescreenshotcapture",
    "getcredentialsheaders","getdeviceintegritytoken","getdeviceintegritytokenyield",
    "nopromptcreateoutfit","nopromptdeleteoutfit","nopromptrenameoutfit",
    "nopromptsaveavatar","nopromptsaveavatarthumbnailcustomization","nopromptsetfavorite",
    "nopromptupdateoutfit","performcreateoutfitwithdescription","performrenameoutfit",
    "performsaveavatarwithdescription","performsetfavorite","performupdateoutfit",
    "promptcreateoutfit","promptdeleteoutfit","promptrenameoutfit","promptsaveavatar",
    "promptsetfavorite","promptupdateoutfit","promptimportfile","promptimportfiles",
    "getusersubscriptionpaymenthistoryasync","getusersubscriptiondetailsinternalasync",
    "callfunction","bindcoreactive","reportabuse","reportabusev3","reportchatabuse",
    "load", "getusersubscriptionstatusasync"
};

static const std::unordered_set<std::string> dangerous_services =
{
    "accountservice","testservice","omnirecommendationsservice","messagebusservice",
    "linkingservice","browserservice","opencloudservice","scriptprofilerservice"
};

static __int64 old_namecall;
static __int64 old_index;

static bool is_dangerous_function(const char* name)
{
    return dangerous_functions.count(to_lower(name)) != 0;
}

static bool is_dangerous_service(const char* name)
{
    return dangerous_services.count(to_lower(name)) != 0;
}

int namecall_hook(lua_State* L) {
    if (L->namecall) {
        const char* method = L->namecall->data;
        std::string m = to_lower(method);

        if (m == "httpget" || m == "httpgetasync") {
            return Http::HttpGet(L);
        }

        if (m == "getobjects" || m == "getobjectsasync") {
            return Miscellaneous::GetObjects(L);
        }
    }

    return ((__int64(__fastcall*)(__int64))old_namecall)((__int64)L);
}


auto index_hook(lua_State* L) -> int {
    if (!*(uintptr_t*)((uintptr_t)L->userdata + 0x80) && lua_isstring(L, 2)) {
        const char* data = lua_tostring(L, 2);
        const char first_char = data[0];

        if (first_char == 'H') {
            if (strcmp(data, "HttpGet") == 0 || strcmp(data, "HttpGetAsync") == 0) {
                lua_getglobal(L, "httpget");
                return 1;
            }
        }
        else if (first_char == 'G') {
            if (strcmp(data, "GetObjects") == 0 || strcmp(data, "GetObjectsAsync") == 0) {
                lua_getglobal(L, "getobjects");
                return 1;
            }
        }
    }

    return ((__int64(__fastcall*)(__int64))old_index)((__int64)L);
}
void InitializeHooks(lua_State* L)
{
    lua_getglobal(L, ("game"));
    lua_getmetatable(L, -1);
    lua_getfield(L, -1, ("__namecall"));

    Closure* namecall = (Closure*)lua_topointer(L, -1);
    lua_CFunction namecall_f = namecall->c.f;
    old_namecall = (__int64)namecall_f;
    namecall->c.f = namecall_hook;

    lua_settop(L, 0);

    lua_getglobal(L, ("game"));
    lua_getmetatable(L, -1);
    lua_getfield(L, -1, ("__index"));

    Closure* index = (Closure*)lua_topointer(L, -1);
    lua_CFunction index_f = index->c.f;
    old_index = (__int64)index_f;
    index->c.f = index_hook;

}

void Environment::SetupEnvironment(lua_State* L)
{
    Closures::RegisterLibrary(L);
    Http::RegisterLibrary(L);
    Miscellaneous::RegisterLibrary(L);

    InitializeHooks(L);
    luaL_sandboxthread(L);

	lua_newtable(L);
	lua_setglobal(L, "_G");

	lua_newtable(L);
	lua_setglobal(L, "shared");
}
